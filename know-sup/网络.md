# 不同网段通信时，为什么就将IP请求发给网关呢

> 在不同网段通信时，为了实现跨网段的通信，需要使用路由器或网关来进行数据转发。当一个设备发送 IP 请求到另一个网络的设备时，它会首先检查目标 IP 地址是否与本地网络的 IP 地址属于同一子网。如果目标 IP 地址不在同一子网中，设备就会将请求发送给默认网关。
>
> 默认网关是指在一个网络中作为出口的设备，负责将数据包转发到其他网络。默认网关的 IP 地址通常设置为该网络中连接到其他网络的路由器的 IP 地址。
>
> 设备将 IP 请求发送给默认网关的原因有以下几点：
>
> 1. 跨网络通信：默认网关可以将数据包转发到其他网络，允许设备与不同网段的设备进行通信。
> 2. 路由决策：默认网关负责根据路由表来决定数据包的下一跳路径。它通过查找目标 IP 地址与路由表中的匹配项来选择正确的路径进行转发。
> 3. NAT 网络地址转换：默认网关也扮演着网络地址转换（NAT）的角色。当数据包从一个网络转发到另一个网络时，它会将源 IP 地址和端口号修改为自己的 IP 地址和端口号，以便响应返回时能够正确路由到发送方。
>
> 综上所述，将 IP 请求发送给网关是为了实现不同网段之间的通信，并且利用网关的路由功能和网络地址转换来确保数据包能够正确传输到目标设备。

# LVS-DR工作原理

> LVS-DR模式（Direct Routing）是Linux Virtual Server中的一种负载均衡方式，它与LVS-NAT和LVS-TUN不同，它不对请求进行地址转换，而是将请求直接路由到后端服务器。
>
> 下面是LVS-DR模式的工作流程：
>
> 1. 客户端发送请求到VIP（Virtual IP）。
> 2. LVS负载均衡器接收到请求并根据调度算法选择一个后端服务器来处理请求。
> 3. LVS负载均衡器使用DMAC（Destination MAC）为所选服务器的MAC地址，将请求直接发送到后端服务器，源IP地址仍然是客户端的IP地址。
> 4. 后端服务器接收到请求后，通过检查DIP（Destination IP）地址，判断该请求是否是发往自己的。
> 5. 如果是，则后端服务器处理请求并生成响应，将响应发送回LVS负载均衡器。此时，源IP地址为后端服务器的IP地址，目标IP地址为客户端的IP地址。
> 6. LVS负载均衡器接收到响应，并使用SMAC（Source MAC）和源IP地址将响应发送回给客户端。
>
> 需要注意的是，在LVS-DR模式下，LVS负载均衡器只是将请求发往后端服务器，并不对请求进行修改或者转换，因此后端服务器必须与LVS负载均衡器在同一子网内，以便负载均衡器可以直接将请求发送到后端服务器。此外，需要在后端服务器上配置VIP地址，并将其与LVS负载均衡器绑定，以便LVS负载均衡器能够正确地将请求路由到后端服务器。

```sh
# 调度器配置：
[root@lvs1 ~]# ipvsadm -a -t 192.168.88.15:80 -r 192.168.88.100 -w 1 -g
[root@lvs1 ~]# ipvsadm -a -t 192.168.88.15:80 -r 192.168.88.200 -w 2 -g
# web1与web2都配置了lo地址为192.168.88.15，且修改内核参数如下：
net.ipv4.conf.all.arp_ignore = 1
net.ipv4.conf.lo.arp_ignore = 1
net.ipv4.conf.all.arp_announce = 2
net.ipv4.conf.lo.arp_announce = 2
```

> <span style='color:red'>根据以上内核参数设置，当一个客户端发送请求到192.168.88.15时，工作流程如下：</span>
>
> 1. 客户端发送请求到VIP（192.168.88.15）。
> 2. IPVS根据负载均衡算法选择一个后端web服务器（192.168.88.100或192.168.88.200）。
> 3. 由于web1和web2都配置了lo地址为192.168.88.15，它们都会接收到请求。这是因为配置了lo地址后，web服务器会认为自己就是VIP，从而接收到发送到VIP的请求。
> 4. 根据内核参数设置，web1和web2都会忽略对VIP的ARP请求（arp_ignore=1），并会在响应中使用自己的MAC地址（arp_announce=2）。这意味着当ARP请求到达时，web服务器不会响应，因为它们忽略了对VIP地址的ARP请求。
> 5. 因此，web1和web2会在响应中使用自己的MAC地址（arp_announce=2）。这意味着当web服务器向客户端发送响应时，它们会使用自己的MAC地址，而不是VIP的MAC地址。无论是web1还是web2都可以作出响应，取决于IPVS的负载均衡算法选择的是哪个后端web服务器。
>
> <span style='color:red;font-weight:bold'>以下是客户三次请求，后端的工作流程</span>
>
> 1. 用户发送第一次请求到VIP（192.168.88.15:80）。
> 2. IPVS根据负载均衡算法选择了后端web服务器1（192.168.88.100）来处理请求。
> 3. 由于web服务器1配置了lo地址为192.168.88.15，它会接收到请求。
> 4. 根据内核参数设置，web服务器1会忽略对VIP的ARP请求（arp_ignore=1），并会在响应中使用自己的MAC地址（arp_announce=2）。
> 5. 因此，web服务器1会使用自己的MAC地址来响应客户端的请求。
> 6. 用户发送第二次请求到VIP（192.168.88.15:80）。
> 7. IPVS再次根据负载均衡算法选择了后端web服务器2（192.168.88.200）来处理请求。
> 8. 由于web服务器2也配置了lo地址为192.168.88.15，它也会接收到请求。
> 9. 类似地，根据内核参数设置，web服务器2会忽略对VIP的ARP请求（arp_ignore=1），并会在响应中使用自己的MAC地址（arp_announce=2）。
> 10. 因此，web服务器2会使用自己的MAC地址来响应客户端的请求。
> 11. 用户发送第三次请求到VIP（192.168.88.15:80）。
> 12. IPVS根据负载均衡算法再次选择了后端web服务器1（192.168.88.100）来处理请求。
> 13. web服务器1会再次使用自己的MAC地址来响应客户端的请求。
>
> 因此，根据这些设置，web1和web2都有能力作出响应，IPVS将根据负载均衡算法选择一个后端web服务器来处理请求。

> <span style='color:red'>所用内核参数详解</span>
>
> 在IPVS中，arp_ignore和arp_announce参数会影响后端服务器对请求的响应。
>
> arp_ignore参数指定了对于哪些接口上的ARP请求要进行忽略。当arp_ignore设置为1时，后端服务器会忽略对VIP地址的ARP请求，这意味着即使收到了发送到VIP地址的ARP请求，后端服务器也不会响应。这样可以确保后端服务器不会接管VIP地址，而是由负载均衡器来管理流量的分发。
>
> arp_announce参数指定了在响应中使用哪个MAC地址。当arp_announce设置为2时，后端服务器会在响应中使用自己的MAC地址，而不是VIP地址的MAC地址。这样可以确保无论是哪个后端服务器响应了请求，它都会使用自己的MAC地址，而不会混淆负载均衡器和其他网络设备。
>
> 因此，通过设置这两个参数，可以确保后端服务器在IPVS负载均衡器的管理下，正确地处理请求并发送响应。